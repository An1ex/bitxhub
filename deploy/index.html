<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BitXHub v1.0.0 规范化部署文档 | BitXHub文档</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="BitXHub部署文档、使用文档、设计文档站">
    <link rel="preload" href="/bitxhub/assets/css/0.styles.fbae815b.css" as="style"><link rel="preload" href="/bitxhub/assets/js/app.3450d84e.js" as="script"><link rel="preload" href="/bitxhub/assets/js/2.9c5ab97b.js" as="script"><link rel="preload" href="/bitxhub/assets/js/6.27cb6483.js" as="script"><link rel="prefetch" href="/bitxhub/assets/js/10.c231280d.js"><link rel="prefetch" href="/bitxhub/assets/js/11.9ee973cb.js"><link rel="prefetch" href="/bitxhub/assets/js/12.46fcade6.js"><link rel="prefetch" href="/bitxhub/assets/js/13.b374135c.js"><link rel="prefetch" href="/bitxhub/assets/js/14.d7888f74.js"><link rel="prefetch" href="/bitxhub/assets/js/15.6d1bf087.js"><link rel="prefetch" href="/bitxhub/assets/js/3.2e17f55f.js"><link rel="prefetch" href="/bitxhub/assets/js/4.5566ec6d.js"><link rel="prefetch" href="/bitxhub/assets/js/5.427bfa4e.js"><link rel="prefetch" href="/bitxhub/assets/js/7.d45d02aa.js"><link rel="prefetch" href="/bitxhub/assets/js/8.ab54e651.js"><link rel="prefetch" href="/bitxhub/assets/js/9.a2be9c30.js">
    <link rel="stylesheet" href="/bitxhub/assets/css/0.styles.fbae815b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bitxhub/" class="home-link router-link-active"><img src="/bitxhub/images/logo.png" alt="BitXHub文档" class="logo"> <span class="site-name can-hide">BitXHub文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://bitxhub.hyperchain.cn/#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/meshplus/bitxhub" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://bitxhub.hyperchain.cn/#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/meshplus/bitxhub" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/bitxhub/quick/" class="sidebar-link">快速开始</a></li><li><a href="/bitxhub/deploy/" aria-current="page" class="active sidebar-link">部署文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bitxhub/deploy/#前提" class="sidebar-link">前提</a></li><li class="sidebar-sub-header"><a href="/bitxhub/deploy/#部署中继链" class="sidebar-link">部署中继链</a></li><li class="sidebar-sub-header"><a href="/bitxhub/deploy/#部署fabric和跨链合约" class="sidebar-link">部署Fabric和跨链合约</a></li><li class="sidebar-sub-header"><a href="/bitxhub/deploy/#部署以太坊和跨链合约" class="sidebar-link">部署以太坊和跨链合约</a></li><li class="sidebar-sub-header"><a href="/bitxhub/deploy/#启动跨链网关" class="sidebar-link">启动跨链网关</a></li><li class="sidebar-sub-header"><a href="/bitxhub/deploy/#发送跨链交易" class="sidebar-link">发送跨链交易</a></li></ul></li><li><a href="/bitxhub/usage/" class="sidebar-link">使用文档</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/bitxhub/develop/" class="sidebar-heading clickable"><span>开发文档</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/bitxhub/faq/" class="sidebar-link">FAQ</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="bitxhub-v1-0-0-规范化部署文档"><a href="#bitxhub-v1-0-0-规范化部署文档" class="header-anchor">#</a> BitXHub v1.0.0 规范化部署文档</h1> <h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>本部署文档将介绍如何部署一个四节点的中继链，以及一条Fabric应用链和一条以太坊应用链。并对应两条应用链部署各自部署跨链网关，以及如何部署和调用跨链合约进行跨链转账操作。</p> <h2 id="前提"><a href="#前提" class="header-anchor">#</a> 前提</h2> <p>本文默认是在在Linux机器上进行操作，有些基础的工具可能要在服务器上提前安装：</p> <ol><li><strong>git</strong></li> <li><strong>docker</strong>（部署Fabric区块链的服务器需要）</li></ol> <h1 id="部署流程"><a href="#部署流程" class="header-anchor">#</a> 部署流程</h1> <h2 id="部署中继链"><a href="#部署中继链" class="header-anchor">#</a> 部署中继链</h2> <h3 id="_1-准备"><a href="#_1-准备" class="header-anchor">#</a> 1.准备</h3> <p>该文档将介绍如何部署一个拥有4个节点的BitXHub集群，操作步骤会较其他系统的部署稍繁琐一些，用户需要**分别登录到4台服务器（或者在一台服务器上设置不同端口)**上进行操作。</p> <p>这里假设4台服务器的IP分别为<code>node1</code>、<code>node2</code>、<code>node3</code>和<code>node4</code>。操作用户都是<code>bitxhub</code>。</p> <h3 id="_2-一键脚本部署"><a href="#_2-一键脚本部署" class="header-anchor">#</a> 2. 一键脚本部署</h3> <p>在bitxhub项目下，提供了一键部署的脚本，适合在有项目权限的情况下进行部署。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>bitxhub<span class="token operator">/</span>scripts
├── build
├── certs
├── cluster<span class="token punctuation">.</span>sh
├── config<span class="token punctuation">.</span>sh
├── cross_compile<span class="token punctuation">.</span>sh
├── deploy<span class="token punctuation">.</span>sh
├── prepare<span class="token punctuation">.</span>sh
├── quick_start
├── solo<span class="token punctuation">.</span>sh
└── x<span class="token punctuation">.</span>sh
</code></pre></div><p>进入bitxhub项目，运行下面的命令进行部署：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## -a 为服务器地址（需要有ssh登陆权限，服务器安装tmux窗口管理器）</span>
<span class="token comment">## -n 为需要在服务器上部署的结点数量</span>
<span class="token comment">## -r 是否需要重新编译项目，可设为true和false</span>
<span class="token comment">## -u 服务器ssh用户名</span>
<span class="token comment">## -p bitxhub部署相对路径</span>
<span class="token comment">## e.g. bash deploy.sh -a 40.125.161.213 -n 4 -r false -u root -p bitxhub</span>

$ <span class="token function">bash</span> deploy.sh <span class="token punctuation">[</span>-a <span class="token operator">&lt;</span>bitxhub_addr<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>-n <span class="token operator">&lt;</span>node_num<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>-r <span class="token operator">&lt;</span>if_recompile<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>-u <span class="token operator">&lt;</span>username<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>-p <span class="token operator">&lt;</span>build_path<span class="token operator">&gt;</span><span class="token punctuation">]</span>
</code></pre></div><h4 id="插件化部署-可选"><a href="#插件化部署-可选" class="header-anchor">#</a> 插件化部署（可选）</h4> <p>进入plugins子目录，运行下面的命令进行编译共识算法插件：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## make raft编译共识算法</span>
$ <span class="token function">make</span> raft
</code></pre></div><p>编译完成后，节点会根据bitxhub.toml文件中的order配置加载不同的共识算法。</p> <h3 id="_3-规范化部署"><a href="#_3-规范化部署" class="header-anchor">#</a> 3. 规范化部署</h3> <h4 id="前言-2"><a href="#前言-2" class="header-anchor">#</a> 前言</h4> <p>该文档将介绍如何部署一个拥有4个节点的BitXHub集群，操作步骤会较其他系统的部署稍繁琐一些，用户需要<strong>分别登录到4台服务器（或者在一台服务器上设置不同端口</strong>上进行操作。</p> <p>这里假设4台服务器的IP分别为<code>node1</code>、<code>node2</code>、<code>node3</code>和<code>node4</code>。操作用户都是<code>bitxhub</code>。</p> <h4 id="_3-1-获取安装包"><a href="#_3-1-获取安装包" class="header-anchor">#</a> 3.1 获取安装包</h4> <p>从下面的命令下载获取BitXHub的 tar 包</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">ssh</span> bitxhub@node1
$ <span class="token function">mkdir</span> <span class="token environment constant">$HOME</span>/.bitxhub
<span class="token comment"># 在Mac环境下</span>
$ <span class="token function">wget</span> https://github.com/meshplus/bitxhub/releases/download/v1.0.0-rc1/build_macos_x86_64_v1.0.0-rc1.tar.gz
$ <span class="token function">tar</span> xvf build_macos_x86_64_v1.0.0-rc1.tar.gz -C <span class="token environment constant">$HOME</span>/.bitxhub
<span class="token comment"># 在Linux环境下</span>
$ <span class="token function">wget</span> https://github.com/meshplus/bitxhub/releases/download/v1.0.0-rc1/build_linux-amd64_v1.0.0-rc1.tar.gz
$ <span class="token function">tar</span> xvf build_linux-amd64_v1.0.0-rc1.tar.gz -C <span class="token environment constant">$HOME</span>/.bitxhub

<span class="token comment"># bitxhub运行需要libwasmer.so动态链接库</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable">$LD_LIBRARY_PATH</span><span class="token builtin class-name">:</span><span class="token environment constant">$HOME</span>/.bitxhub/build
</code></pre></div><p>解压完成之后，会在 <code>$HOME/.bitxhub</code> 下看到如下build目录</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">.</span>
├── addresses
├── agency<span class="token punctuation">.</span>cert
├── agency<span class="token punctuation">.</span>priv
├── bitxhub
├── ca<span class="token punctuation">.</span>cert
├── ca<span class="token punctuation">.</span>priv
├── libwasmer<span class="token punctuation">.</span>so
├── node1
│   ├── <span class="token constant">README</span><span class="token punctuation">.</span>md
│   ├── api
│   ├── bitxhub<span class="token punctuation">.</span>toml
│   ├── certs<span class="token operator">/</span>
│   ├── genesis<span class="token punctuation">.</span>json
│   ├── network<span class="token punctuation">.</span>toml
│   ├── order<span class="token punctuation">.</span>toml
│   ├── plugins
│   └── start<span class="token punctuation">.</span>sh
├── node2
│   ├── <span class="token constant">README</span><span class="token punctuation">.</span>md
│   ├── api
│   ├── bitxhub<span class="token punctuation">.</span>toml
│   ├── certs<span class="token operator">/</span>
│   ├── genesis<span class="token punctuation">.</span>json
│   ├── network<span class="token punctuation">.</span>toml
│   ├── order<span class="token punctuation">.</span>toml
│   ├── plugins
│   └── start<span class="token punctuation">.</span>sh
├── node3
│   ├── <span class="token constant">README</span><span class="token punctuation">.</span>md
│   ├── api
│   ├── bitxhub<span class="token punctuation">.</span>toml
│   ├── certs<span class="token operator">/</span>
│   ├── genesis<span class="token punctuation">.</span>json
│   ├── network<span class="token punctuation">.</span>toml
│   ├── order<span class="token punctuation">.</span>toml
│   ├── plugins
│   └── start<span class="token punctuation">.</span>sh
├── node4
│   ├── <span class="token constant">README</span><span class="token punctuation">.</span>md
│   ├── api
│   ├── bitxhub<span class="token punctuation">.</span>toml
│   ├── certs<span class="token operator">/</span>
│   ├── genesis<span class="token punctuation">.</span>json
│   ├── network<span class="token punctuation">.</span>toml
│   ├── order<span class="token punctuation">.</span>toml
│   ├── plugins
│   └── start<span class="token punctuation">.</span>sh
├── pids
├── raft<span class="token punctuation">.</span>so
└── solo<span class="token punctuation">.</span>so
</code></pre></div><p>该部署包已经包含了四个节点的配置目录，如果是在多台服务器上部署，每台服务器上操作时只需要修改其中一个节点的配置目录即可。</p> <h4 id="_3-2-修改配置文件"><a href="#_3-2-修改配置文件" class="header-anchor">#</a> 3.2 修改配置文件</h4> <p>下面以node1为例介绍如何修改配置文件</p> <p><strong>修改bitxhub.toml文件</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>title <span class="token operator">=</span> <span class="token string">&quot;BitXHub configuration file&quot;</span>
<span class="token comment"># 是否按照单结点模式启动BitXHub</span>
solo <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token comment"># BitXHub提供服务的端口，确保和已占用的端口不冲突</span>
<span class="token punctuation">[</span>port<span class="token punctuation">]</span>
  grpc <span class="token operator">=</span> <span class="token number">60011</span>
  gateway <span class="token operator">=</span> <span class="token number">9091</span>
  pprof <span class="token operator">=</span> <span class="token number">53121</span>

<span class="token punctuation">[</span>pprof<span class="token punctuation">]</span>
  <span class="token builtin class-name">enable</span> <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment"># 网关白名单</span>
<span class="token punctuation">[</span>gateway<span class="token punctuation">]</span>
    allowed_origins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">]</span>

<span class="token comment"># 日志输出相关设置</span>
<span class="token punctuation">[</span>log<span class="token punctuation">]</span>
  level <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span>
  <span class="token function">dir</span> <span class="token operator">=</span> <span class="token string">&quot;logs&quot;</span>
  filename <span class="token operator">=</span> <span class="token string">&quot;bitxhub.log&quot;</span>
  report_caller <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">[</span>log.module<span class="token punctuation">]</span>
    p2p <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span>
    consensus <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span>
    executor <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span>
    router <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span>
    api <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span>
    coreapi <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span>

<span class="token punctuation">[</span>cert<span class="token punctuation">]</span>
  verify <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment"># BitXHub使用的共识算法，共识模块作为插件进行加载</span>
<span class="token punctuation">[</span>order<span class="token punctuation">]</span>
  plugin <span class="token operator">=</span> <span class="token string">&quot;plugins/raft.so&quot;</span>

<span class="token comment"># BitXHub启动的创世块信息</span>
<span class="token punctuation">[</span>genesis<span class="token punctuation">]</span>
    addresses <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;0xe6f8c9cf6e38bd506fae93b73ee5e80cc8f73667&quot;</span>,
        <span class="token string">&quot;0x8374bb1e41d4a4bb4ac465e74caa37d242825efc&quot;</span>,
        <span class="token string">&quot;0x759801eab44c9a9bbc3e09cb7f1f85ac57298708&quot;</span>,
        <span class="token string">&quot;0xf2d66e2c27e93ff083ee3999acb678a36bb349bb&quot;</span>
    <span class="token punctuation">]</span>
</code></pre></div><p><strong>修改network.toml文件</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># BitXHub结点的IP和端口信息，BitXHub结点的id具有唯一性</span>
N <span class="token operator">=</span> <span class="token number">4</span>
<span class="token comment"># 推荐在node1服务器上配置为id=1,其他node的服务器ID递增</span>
<span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span>nodes<span class="token punctuation">]</span><span class="token punctuation">]</span>
  addr <span class="token operator">=</span> <span class="token string">&quot;/ip4/127.0.0.1/tcp/4001/p2p/Qma1oh5JtrV24gfP9bFrVv4miGKz7AABpfJhZ4F2Z5ngmL&quot;</span>
  <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span>nodes<span class="token punctuation">]</span><span class="token punctuation">]</span>
  addr <span class="token operator">=</span> <span class="token string">&quot;/ip4/127.0.0.1/tcp/4002/p2p/QmTGbPAfCYiAYDwYytt3QQLn3fq79dzciyP9kTFYWr8Lqb&quot;</span>
  <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">2</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span>nodes<span class="token punctuation">]</span><span class="token punctuation">]</span>
  addr <span class="token operator">=</span> <span class="token string">&quot;/ip4/127.0.0.1/tcp/4003/p2p/QmNxNoU52ZmSaeFS9MEUHAvusp6iqoqZRKnpoKwUvHkVdB&quot;</span>
  <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">3</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span>nodes<span class="token punctuation">]</span><span class="token punctuation">]</span>
  addr <span class="token operator">=</span> <span class="token string">&quot;/ip4/127.0.0.1/tcp/4004/p2p/QmaKBzZw94uqRRr5w8n4DMzrYcJ8V9VkyVYRxBSYYvi1te&quot;</span>
  <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">4</span>

</code></pre></div><p>按照上面配置的注释相应的进行修改，其中需要注意的是：每个节点的 <code>addr</code> 的最后一段ID需要进行修改。</p> <div class="language-shell extra-class"><pre class="language-shell"><code> $ <span class="token environment constant">$HOME</span>/.bitxhub/build/bitxhub key pid --path <span class="token environment constant">$HOME</span>/.bitxhub/build/node1/certs/node.priv
</code></pre></div><p>运行上面的命令会得到类似于 <code>QmP62PJJBSZCYLDdfFEraxG4pACAR2k83JEDY59zsM4HD2</code> 的一个ID，将此ID替换 <code>network.toml</code> 中 <code>node1</code> 的 <code>addr</code> 后缀即可，比如：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>addr <span class="token operator">=</span> <span class="token string">&quot;/ip4/127.0.0.1/tcp/4001/p2p/Qma1oh5JtrV24gfP9bFrVv4miGKz7AABpfJhZ4F2Z5ngmL&quot;</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> 修改为
addr <span class="token operator">=</span> <span class="token string">&quot;/ip4/127.0.0.1/tcp/4001/p2p/QmP62PJJBSZCYLDdfFEraxG4pACAR2k83JEDY59zsM4HD2&quot;</span>
</code></pre></div><p>其他节点同理进行修改即可。</p> <p><strong>修改order.toml</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code># 共识算法插件的配置文件

<span class="token punctuation">[</span>raft<span class="token punctuation">]</span>
election_tick               <span class="token operator">=</span> <span class="token number">10</span> # ElectionTick is the number <span class="token keyword">of</span> Node<span class="token punctuation">.</span>Tick invocations that must pass between elections<span class="token punctuation">.</span>
heartbeat_tick              <span class="token operator">=</span> <span class="token number">1</span> # HeartbeatTick is the number <span class="token keyword">of</span> Node<span class="token punctuation">.</span>Tick invocations that must pass between heartbeats<span class="token punctuation">.</span>
max_size_per_msg            <span class="token operator">=</span> <span class="token number">1048576</span> # <span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">,</span> MaxSizePerMsg limits the max size <span class="token keyword">of</span> each append message<span class="token punctuation">.</span>
max_inflight_msgs           <span class="token operator">=</span> <span class="token number">500</span> # MaxInflightMsgs limits the max number <span class="token keyword">of</span> <span class="token keyword">in</span><span class="token operator">-</span>flight append messages during optimistic replication phase<span class="token punctuation">.</span>
check_quorum                <span class="token operator">=</span> <span class="token boolean">true</span> # Leader steps down when quorum is not active <span class="token keyword">for</span> an electionTimeout<span class="token punctuation">.</span>
pre_vote                    <span class="token operator">=</span> <span class="token boolean">true</span> # PreVote prevents reconnected node <span class="token keyword">from</span> disturbing network<span class="token punctuation">.</span>
disable_proposal_forwarding <span class="token operator">=</span> <span class="token boolean">true</span> # This prevents blocks <span class="token keyword">from</span> being accidentally proposed by followers<span class="token punctuation">.</span>
    <span class="token punctuation">[</span>raft<span class="token punctuation">.</span>tx_pool<span class="token punctuation">]</span>
        pack_size           <span class="token operator">=</span> <span class="token number">500</span> # How many transactions should the primary pack<span class="token punctuation">.</span>
        pool_size           <span class="token operator">=</span> <span class="token number">50000</span> # How many transactions could the txPool stores <span class="token keyword">in</span> total<span class="token punctuation">.</span>
        block_tick          <span class="token operator">=</span> <span class="token string">&quot;500ms&quot;</span> # Block packaging time period<span class="token punctuation">.</span>
</code></pre></div><h4 id="_3-3-启动bitxhub"><a href="#_3-3-启动bitxhub" class="header-anchor">#</a> 3.3 启动BitXHub</h4> <p>将bitxhub和raft.so二进制放到各自的node目录下，再执行下面的命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">cp</span> <span class="token environment constant">$HOME</span>/.bitxhub/build/bitxhub <span class="token environment constant">$HOME</span>/.bitxhub/build/node/
$ <span class="token function">cp</span> <span class="token environment constant">$HOME</span>/.bitxhub/build/raft.so <span class="token environment constant">$HOME</span>/.bitxhub/build/node/plugins/
$ <span class="token builtin class-name">cd</span> <span class="token environment constant">$HOME</span>/.bitxhub/build/node1
$ <span class="token function">bash</span> start.sh
</code></pre></div><p>等待BitXHub进行共识，打印出BitXHub标志后即部署成功。</p> <h2 id="部署fabric和跨链合约"><a href="#部署fabric和跨链合约" class="header-anchor">#</a> 部署Fabric和跨链合约</h2> <h3 id="_1-部署fabric"><a href="#_1-部署fabric" class="header-anchor">#</a> 1. 部署Fabric</h3> <p>按照Fabric<a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/build_network.html" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>启动一条默认配置的Fabric 1.4.3版本的区块链即可。</p> <p>在你的机器上启动Fabric 1.4.3 的应用链之后，会得到一个crypto-config的文件夹，这个文件夹在后面跨链网关的部署流程中会用到。</p> <h3 id="_2-部署-chaincode"><a href="#_2-部署-chaincode" class="header-anchor">#</a> 2. 部署 chaincode</h3> <p>要将Fabric接入跨链系统，需要在Fabric上部署跨链合约。</p> <p>下载chaincode跨链合约</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">wget</span> https://github.com/meshplus/pier-client-fabric/raw/master/example/contracts.zip
$ <span class="token function">unzip</span> contract.zip
</code></pre></div><p>我们提供的跨链合约提供了一个跨链管理合约 <code>broker</code> 和两个样例应用合约 <code>transfer</code>和 <code>data_swapper</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>└── src
    ├── broker
    │   ├── broker.go
    │   ├── data_swapper.go
    │   ├── helper.go
    │   ├── meta.go
    │   └── transfer.go
    ├── data_swapper
    │   └── data_swapper.go
    └── transfer
        ├── helper.go
        └── transfer.go
</code></pre></div><p>将这几个合约部署到Fabric上即可，chaincode名称推荐使用对应的项目名不用改变。</p> <p><strong>broker合约对应用合约进行审核</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>broker <span class="token operator">*</span>Broker<span class="token punctuation">)</span> <span class="token function">audit</span><span class="token punctuation">(</span>stub shim<span class="token punctuation">.</span>ChaincodeStubInterface<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> pb<span class="token punctuation">.</span>Response <span class="token punctuation">{</span>
	channel <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	chaincodeName <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	status <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用broker合约中的 <code>audit</code> 方法，参数是 fabric网络中channel名 + chaincode名称 + 1（数字1表示审核代码通过）</p> <h2 id="部署以太坊和跨链合约"><a href="#部署以太坊和跨链合约" class="header-anchor">#</a> 部署以太坊和跨链合约</h2> <h3 id="_1-部署以太坊私链"><a href="#_1-部署以太坊私链" class="header-anchor">#</a> 1. 部署以太坊私链</h3> <p>使用以太坊私链只是为了演示跨链流程，建议使用Geth 客户端的Dev 模式进行启动，并且需要开启websocket端口和RPC端口。</p> <h3 id="_2-部署solidity跨链合约"><a href="#_2-部署solidity跨链合约" class="header-anchor">#</a> 2. 部署Solidity跨链合约</h3> <p>下载Solidity跨链合约</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">git</span> clone https://github.com/meshplus/pier-client-ethereum.git
$ <span class="token builtin class-name">cd</span> pier-client-ethereum/example
</code></pre></div><p>我们提供的Solidity跨链合约提供了一个跨链管理合约 <code>broker</code> 和两个样例应用合约 <code>transfer</code>和 <code>data_swapper</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">.</span>
├── broker.sol
├── data_swapper.sol
└── transfer.sol
</code></pre></div><p>部署合约的先后顺序需要注意，需要首先部署 <code>broker</code> 合约，得到它的地址比如是 <code>0xD3880ea40670eD51C3e3C0ea089fDbDc9e3FBBb4</code></p> <p>再修改 <code>data_swapper</code> 和 <code>transfer</code> 代码中的 <code>broker</code> 地址，以 <code>data_swapper</code> 为例说明如何修改：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>contract DataSwapper <span class="token punctuation">{</span>
	address BrokerAddr <span class="token operator">=</span> <span class="token number">0x2346f3BA3F0B6676aa711595daB8A27d0317DB57</span><span class="token punctuation">;</span> <span class="token comment">// 替换为你部署broker得到的地址</span>
	Broker broker <span class="token operator">=</span> <span class="token function">Broker</span><span class="token punctuation">(</span>BrokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>才能进行 <code>data_swapper</code> 和 <code>transfer</code> 的部署操作。</p> <p><strong>broker合约对应用合约进行审核</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">audit</span><span class="token punctuation">(</span><span class="token parameter">address addr<span class="token punctuation">,</span> int64 status</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span><span class="token punctuation">(</span>bool<span class="token punctuation">)</span>
</code></pre></div><p>调用broker合约中的 <code>audit</code> 方法，参数是之前部署得到的 <code>transfer</code> 或者 <code>data_swapper</code> 合约地址 + 1（数字1表示审核代码通过）</p> <h2 id="启动跨链网关"><a href="#启动跨链网关" class="header-anchor">#</a> 启动跨链网关</h2> <h3 id="_1-获取安装包"><a href="#_1-获取安装包" class="header-anchor">#</a> 1. 获取安装包</h3> <p>从下面的链接获取跨链网关的二进制安装包并进行安装：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 在Mac环境下</span>
$ <span class="token function">wget</span> https://github.com/meshplus/pier/releases/download/v1.0.0-rc1/pier-macos-x86-64.tar.gz
$ <span class="token function">mkdir</span> pier-binary <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> xvf pier-macos-x86-64.tar.gz -C pier-binary
<span class="token comment"># 在Linux环境下</span>
$ <span class="token function">wget</span> https://github.com/meshplus/pier/releases/download/v1.0.0-rc1/pier-linux-amd64.tar.gz
$ <span class="token function">mkdir</span> pier-binary <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> xvf pier-linux-amd64.tar.gz -C pier-binary

<span class="token comment"># pier运行需要libwasmer.so动态链接库(Linux下)或者 libwasmer.dylib（Mac下）</span>
<span class="token comment"># Linux下</span>
$ <span class="token function">wget</span> https://raw.githubusercontent.com/meshplus/bitxhub/master/build/libwasmer.so -O pier-binary/libwasmer.so
<span class="token comment"># Mac下</span>
$ <span class="token function">wget</span> https://raw.githubusercontent.com/meshplus/bitxhub/master/build/libwasmer.dylib -O pier-binary/libwasmer.dylib
<span class="token comment"># 两个平台都要执行</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable">$LD_LIBRARY_PATH</span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/pier-binary/
</code></pre></div><p>解压后可以看到下面的文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code>- pier-binary
├── eth-client.so
├── fabric1.4-client.so
├── pier
</code></pre></div><p>eth-client.so 和 fabric1.4-client.so分别用于以太坊和Fabric的跨链网关的启动。</p> <p>并将 <code>pier</code> 放到环境变量目录下</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">cp</span> pier-binary/pier /usr/local/bin/
</code></pre></div><h3 id="_2-跨链网关配置"><a href="#_2-跨链网关配置" class="header-anchor">#</a> 2. 跨链网关配置</h3> <p>Pier 需要配置中继链和应用链的相关信息，可以指定配置目录，默认路径为 <code>$HOME/.pier</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># fabric 应用链初始化为$HOME/.pier1，以太坊应用链初始化为$HOME/.pier2，区分开即可</span>
$ pier --repo<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier1 init

<span class="token comment"># 查看具体的配置内容</span>
$ <span class="token function">cat</span> <span class="token environment constant">$HOME</span>/.pier1/pier.toml
</code></pre></div><p>主要需要修改的部分是端口信息、中继链的信息、应用链的信息</p> <ul><li>修改端口信息</li></ul> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">port</span><span class="token punctuation">]</span>
<span class="token comment"># 如果不冲突的话，可以不用修改</span>
<span class="token key property">http</span> <span class="token punctuation">=</span> <span class="token number">44544</span>
<span class="token key property">pprof</span> <span class="token punctuation">=</span> <span class="token number">44555</span>
</code></pre></div><ul><li>修改中继链信息</li></ul> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">bitxhub</span><span class="token punctuation">]</span>
<span class="token comment"># 在服务器启动的bitxhub需要修改为服务器地址</span>
<span class="token key property">addr</span> <span class="token punctuation">=</span> <span class="token string">&quot;localhost:60011&quot;</span>

<span class="token comment"># 修改为BitXHub节点的地址</span>
<span class="token key property">validators</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;0x000f1a7a08ccc48e5d30f80850cf1cf283aa3abd&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;0xe93b92f1da08f925bdee44e91e7768380ae83307&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;0xb18c8575e3284e79b92100025a31378feb8100d6&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;0x856E2B9A5FA82FD1B031D1FF6863864DBAC7995D&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><ul><li>修改应用链信息</li></ul> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">appchain</span><span class="token punctuation">]</span>
<span class="token comment"># 所连接的应用链对应的Plugin文件在跨链网关配置文件夹下的相对路径</span>
<span class="token key property">plugin</span> <span class="token punctuation">=</span> <span class="token string">&quot;fabric-client-1.4.so&quot;</span>

<span class="token comment"># 所连接的应用链的配置文件夹在跨链网关配置文件夹下的相对路径</span>
<span class="token key property">config</span> <span class="token punctuation">=</span> <span class="token string">&quot;fabric&quot;</span>
</code></pre></div><h3 id="_3-fabric应用链插件配置"><a href="#_3-fabric应用链插件配置" class="header-anchor">#</a> 3. Fabric应用链插件配置</h3> <p>插件配置的模板在<code>pier-client-fabric</code>项目中</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.pier1/plugins

<span class="token comment"># 转到下载解压后的二进制文件夹</span>
$ <span class="token function">cp</span> ./pier-binary/fabric1.4-client.so <span class="token environment constant">$HOME</span>/.pier1/plugins/fabric-client-1.4.so

<span class="token comment"># 转到pier-client-fabric项目路径下</span>
$ <span class="token function">git</span> clone https://github.com/meshplus/pier-client-fabric.git <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> pier-client-fabric
$ <span class="token function">cp</span> ./config <span class="token environment constant">$HOME</span>/.pier1/fabric
</code></pre></div><p>插件配置主要文件有</p> <div class="language- extra-class"><pre class="language-text"><code>├── fabric
│   ├── config.yaml
|   └── crypto-config/
│   └── fabric.toml
│   └── fabric.validators
</code></pre></div><p>主要修改Fabric网络配置，验证证书，跨链合约设置：</p> <ul><li>Fabric网络配置</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 复制你所部署的Fabric所产生的crypto-config文件夹</span>
$ <span class="token function">cp</span> -r /path/to/crypto-config <span class="token environment constant">$HOME</span>/.pier1/fabric/

<span class="token comment"># 复制Fabric上验证人证书</span>
$ <span class="token function">cp</span> <span class="token environment constant">$HOME</span>/.pier1/fabric/crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/msp/signcerts/peer1.org2.example.com-cert.pem <span class="token environment constant">$HOME</span>/.pier1/fabric/fabric.validators
</code></pre></div><ul><li>修改 config.yaml 文件</li></ul> <p><code>config.yaml</code>文件记录的Fabric网络配置，需要使用绝对路径，把所有的路径都修改为 <code>crypto-config</code>文件夹所在的绝对路径。</p> <div class="language- extra-class"><pre class="language-text"><code>path: {CONFIG_PATH}/fabric/crypto-config =&gt; path: $HOME/.pier/fabric/crypto-config
</code></pre></div><p>同时需要修改所有的Fabric 的IP地址，如：</p> <div class="language- extra-class"><pre class="language-text"><code>url: grpcs://localhost:7050 =&gt; url: grpcs://10.1.16.48:7050
</code></pre></div><ul><li>修改跨链合约相关配置</li></ul> <p>修改 fabric.toml 文件</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token key property">addr</span> <span class="token punctuation">=</span> <span class="token string">&quot;localhost:7053&quot;</span> <span class="token comment"># 若Fabric部署在服务器上，该为服务器地址</span>
<span class="token key property">event_filter</span> <span class="token punctuation">=</span> <span class="token string">&quot;interchain-event-name&quot;</span>
<span class="token key property">username</span> <span class="token punctuation">=</span> <span class="token string">&quot;Admin&quot;</span>
<span class="token key property">ccid</span> <span class="token punctuation">=</span> <span class="token string">&quot;broker&quot;</span> <span class="token comment"># 若部署跨链broker合约名字不是broker需要修改</span>
<span class="token key property">channel_id</span> <span class="token punctuation">=</span> <span class="token string">&quot;mychannel&quot;</span>
<span class="token key property">org</span> <span class="token punctuation">=</span> <span class="token string">&quot;org2&quot;</span>
</code></pre></div><h3 id="_4-以太坊应用链插件配置"><a href="#_4-以太坊应用链插件配置" class="header-anchor">#</a> 4. 以太坊应用链插件配置</h3> <p>插件配置的模板在<code>pier-client-ethereum</code>项目中</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.pier2/plugins

<span class="token comment"># 转到下载解压后的二进制文件夹</span>
$ <span class="token function">cp</span> ./pier-binary/eth-client.so <span class="token environment constant">$HOME</span>/.pier2/plugins/eth-client.so

<span class="token comment"># 转到pier-client-ethereum项目路径下</span>
$ <span class="token function">git</span> clone https://github.com/meshplus/pier-client-ethereum.git <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> pier-client-ethereum
$ <span class="token function">cp</span> ./config <span class="token environment constant">$HOME</span>/.pier2/ether
</code></pre></div><p>插件配置主要文件有</p> <div class="language- extra-class"><pre class="language-text"><code>ether
├── account.key
├── broker.abi
├── ether.validators
├── ethereum.toml
└── password
</code></pre></div><p>主要修改以太坊的账号信息，跨链合约设置：</p> <ul><li><p>账户配置</p> <p>将你在以太坊私链上有足够余额的账号私钥文件替换 <code>account.key</code> 文件，文件内容格式如下：</p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">{</span><span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;20f7fac801c5fc3f7e20cfbadaa1cdb33d818fa3&quot;</span>,<span class="token string">&quot;crypto&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;cipher&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;aes-128-ctr&quot;</span>,<span class="token string">&quot;ciphertext&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;8b60c0de32b4f06cc14932cdff70b3c01ecc21c25fcbfd0ad582f2bd19af7c30&quot;</span>,<span class="token string">&quot;cipherparams&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;iv&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;29738398b8a2df14f74a81a4b547e3f6&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;kdf&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;scrypt&quot;</span>,<span class="token string">&quot;kdfparams&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;dklen&quot;</span>:32,<span class="token string">&quot;n&quot;</span>:262144,<span class="token string">&quot;p&quot;</span>:1,<span class="token string">&quot;r&quot;</span>:8,<span class="token string">&quot;salt&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2a26869c26b03202cc3e7b136742ac3c1793675912aa33a8adab1b15749b0dcd&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;mac&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0a4a5234df68e7fe014e6c09c1c6de36c3be08081f713d39512bdf82c9a6500c&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1f4f2381-aff1-40e0-9819-6c93f0645a6b&quot;</span>,<span class="token string">&quot;version&quot;</span>:3<span class="token punctuation">}</span>
</code></pre></div><p>​	如果你的账号有设置密码才能解冻账号，在password文件中写入密码即可</p> <div class="language- extra-class"><pre class="language-text"><code># 填入你的密码
123
</code></pre></div><ul><li><p>修改 ethereum.toml 文件</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">Ether</span><span class="token punctuation">]</span>
<span class="token comment"># 私链的IP地址和提供websocket服务的端口</span>
<span class="token key property">addr</span> <span class="token punctuation">=</span> <span class="token string">&quot;ws://localhost:8546&quot;</span> 
<span class="token comment"># 自定义的应用链名称</span>
<span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;ether&quot;</span>
<span class="token comment"># 部署在私链上的Broker合约地址</span>
<span class="token key property">contract_address</span> <span class="token punctuation">=</span> <span class="token string">&quot;0xD3880ea40670eD51C3e3C0ea089fDbDc9e3FBBb4&quot;</span>
<span class="token comment"># Broker合约对应的ABI文件</span>
<span class="token key property">abi_path</span> <span class="token punctuation">=</span> <span class="token string">&quot;broker.abi&quot;</span>
<span class="token comment"># 有足够余额的账号秘钥文件名称</span>
<span class="token key property">key_path</span> <span class="token punctuation">=</span> <span class="token string">&quot;account.key&quot;</span>
<span class="token comment"># 解冻该账户的密码</span>
<span class="token key property">password</span> <span class="token punctuation">=</span> <span class="token string">&quot;password&quot;</span>
</code></pre></div></li></ul> <h3 id="_5-启动跨链网关"><a href="#_5-启动跨链网关" class="header-anchor">#</a> 5. 启动跨链网关</h3> <p>运行下面的命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 转到二进制下载解压目录并执行</span>
<span class="token comment"># 启动Fabric的跨链网关</span>

<span class="token comment"># 先向中继链注册应用链，其中${APPCHAIN_NAME} 为自定义的名称，法律链等都可以</span>
pier --repo<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier1 appchain register --name<span class="token operator">=</span><span class="token variable">${APPCHAIN_NAME}</span> --type<span class="token operator">=</span>fabric --validators<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier1/fabric/fabric.validators --desc<span class="token operator">=</span><span class="token string">&quot;fabric appchain for test&quot;</span> --version<span class="token operator">=</span><span class="token number">1.4</span>.3
<span class="token comment"># 向中继链注册验证规则</span>
pier --repo<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier1 rule deploy --path<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier1/validating.wasm

$ pier --repo <span class="token environment constant">$HOME</span>/.pier1 start 

<span class="token comment"># 启动以太坊的跨链网关</span>
<span class="token comment"># 先向中继链注册应用链，其中${APPCHAIN_NAME} 为自定义的名称，法律链等都可以</span>
pier --repo<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier2 appchain register --name<span class="token operator">=</span><span class="token variable">${APPCHAIN_NAME}</span> --type<span class="token operator">=</span>ethereum --validators<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier2/ether/ether.validators --desc<span class="token operator">=</span><span class="token string">&quot;ethereum appchain for test&quot;</span> --version<span class="token operator">=</span><span class="token number">1.9</span>.3
<span class="token comment"># 向中继链注册验证规则</span>
pier --repo<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier2 rule deploy --path<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.pier2/validating.wasm

$ pier --repo <span class="token environment constant">$HOME</span>/.pier2 start 
</code></pre></div><p>根据跨链网关打印的相应日志信息可以判断跨链网关的运行情况。</p> <h2 id="发送跨链交易"><a href="#发送跨链交易" class="header-anchor">#</a> 发送跨链交易</h2> <p>按照上面的步骤，在你的两条Fabric上应该已经部署了一个 <code>broker</code> 合约，一个<code>transfer</code>合约。</p> <p><code>broker</code>合约管理所有从应用链上发出的跨链交易，并抛出跨链事件。transfer合约是应用合约，负责具体的应用逻辑。该合约实现了一个简单的模拟账户，能够记录账号名和对应的账户余额，作为一个简单的应用合约。</p> <p>由于不是所有的应用合约都能随便调用broker合约的接口进行跨链，因此 broker 要对进行跨链的应用合约进行权限控制，我们利用broker来审核应用合约地址的方式进行控制。</p> <h3 id="broker-审核-应用合约"><a href="#broker-审核-应用合约" class="header-anchor">#</a> broker 审核 应用合约</h3> <p>在chaincode的broker合约中，也提供了一个 <code>audit</code> 方法进行审核，函数的参数依次为应用合约（在此样例中就是 <code>transfer</code> 合约）所在的通道名，应用合约 chaincode名称，<code>status</code> 是最后的审核状态，1表示审核通过，2表示拒绝。如 <code>audit(mychannel, transfer, 1)</code>。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>broker <span class="token operator">*</span>Broker<span class="token punctuation">)</span> <span class="token function">audit</span><span class="token punctuation">(</span>stub shim<span class="token punctuation">.</span>ChaincodeStubInterface<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> pb<span class="token punctuation">.</span>Response <span class="token punctuation">{</span>
	channel <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	chaincodeName <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	status <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>	
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用此方法即可进行审核。</p> <h3 id="跨链准备"><a href="#跨链准备" class="header-anchor">#</a> 跨链准备</h3> <p>进行跨链转账之前，我们先在样例合约中设置一个账户，并给定余额。</p> <p>在chaincode 的 transfer 合约中，我们提供了 <code>setBalance</code> 方法设置账户余额。<code>name</code> 是账户名称，<code>amount</code> 是账户余额。如 <code>setBalance(Bob, 10000)</code>。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Transfer<span class="token punctuation">)</span> <span class="token function">setBalance</span><span class="token punctuation">(</span>stub shim<span class="token punctuation">.</span>ChaincodeStubInterface<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> pb<span class="token punctuation">.</span>Response <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	name <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	amount <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同样的，也提供了 <code>getBalance</code> 方法来查询账户余额，id 是账户名称。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Transfer<span class="token punctuation">)</span> <span class="token function">getBalance</span><span class="token punctuation">(</span>stub shim<span class="token punctuation">.</span>ChaincodeStubInterface<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> pb<span class="token punctuation">.</span>Response <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	name <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>设置账户余额之后，再调用该接口查询一下设置的账户余额值，以确保操作成功。</p> <h3 id="调用跨链转账接口"><a href="#调用跨链转账接口" class="header-anchor">#</a> 调用跨链转账接口</h3> <p>要进行跨链操作的话，需要通过应用合约调用 broker 合约相应跨链接口。我们提供的样例合约 transfer 中已经写好了方法来进行跨链转账。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Transfer<span class="token punctuation">)</span> <span class="token function">transfer</span><span class="token punctuation">(</span>stub shim<span class="token punctuation">.</span>ChaincodeStubInterface<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> pb<span class="token punctuation">.</span>Response <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	destChainID <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	destAddr <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	sender <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
	receiver <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
	amount <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 <code>destChainID</code> 是跨链目的链的 ID，可以通过下面的命令，根据配置目录获相应取应用链的ID：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ pier --repo ~/.pier1 <span class="token function">id</span> <span class="token comment"># 如果你在其他路径下初始化的跨链网关，--repo指定的路径相应替换</span>
</code></pre></div><p><code>destAddr</code> 是目的链上的合约唯一ID，对于Fabric上的 chaincode（没有合约地址的概念），使用 &quot;{channel}&amp;​{chaincodename}&quot;（比如将 transfer的chaincode部署在你的 mychannel上，chaincode部署的名称是 transfer，那么这个chaincode的唯一ID为(“mychannel&amp;transfer&quot; )；</p> <p><code>sender</code> 为来源链上账户的名称（按照上面的设置为Alice或者Bob）;</p> <p><code>receiver</code> 为目的链上的账户名称（按照上面的设置为Alice或者Bob）;</p> <p><code>amount</code> 为要转账的金额。</p> <p><strong>FabricA -&gt; FabricB的跨链转账：</strong></p> <p>调用 chaincode 的 transfer合约的transfer方法，例如：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#                destChainID(FabricB应用链的ID              destAddr        sender receiver amount</span>
transfer<span class="token punctuation">(</span>0x9f5cf4b97965ababe19fcf3f1f12bb794a7dc279, <span class="token string">&quot;mychannel&amp;transfer&quot;</span>, Alice,    Bob,    <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>提示：具体的用来调用Fabric合约的工具我们不做要求，可以根据你的使用习惯来指定。Fabric部署和调用合约来说，可以参考Fabric官方教程，也可以使用其他开源的工具。</strong></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/bitxhub/quick/" class="prev">
        快速开始
      </a></span> <span class="next"><a href="/bitxhub/usage/">
        使用文档
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/bitxhub/assets/js/app.3450d84e.js" defer></script><script src="/bitxhub/assets/js/2.9c5ab97b.js" defer></script><script src="/bitxhub/assets/js/6.27cb6483.js" defer></script>
  </body>
</html>
